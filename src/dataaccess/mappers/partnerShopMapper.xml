<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="PartnerShopMapper">

  <!-- 총 개수 조회 (옵션: 상태 필터) -->
  <select id="countPartnerShops">
    SELECT COUNT(*) AS total
    FROM partner_shop ps
    <where>
      <if test="status != null and status != ''">
        ps.status = #{status}
      </if>
    </where>
  </select>

  <!-- 제휴매장 목록 조회 (옵션: 상태 필터) -->
  <select id="selectPartnerShops">
    SELECT ps.*, s.title
    FROM partner_shop ps
    JOIN shop s ON ps.shop_id = s.id
    <where>
      <if test="status != null and status != ''">
        ps.status = #{status}
      </if>
    </where>
    ORDER BY ps.id DESC
    LIMIT ${limit} OFFSET ${offset}
  </select>

  <!-- 특정 shop_id로 제휴매장 조회 -->
  <select id="findByShopId">
    SELECT ps.*, s.title
    FROM partner_shop ps
    JOIN shop s ON ps.shop_id = s.id
    WHERE ps.shop_id = #{shopId}
  </select>

  <!-- shop 존재 여부 확인 -->
  <select id="existsShopById">
    SELECT COUNT(1) AS cnt
    FROM shop
    WHERE id = #{shopId}
  </select>

  <!-- 제휴매장 등록 -->
  <insert id="insertPartnerShop">
    INSERT INTO partner_shop (shop_id, partner_date, expiry_date, status)
    VALUES (#{shopId}, #{partnerDate}, #{expiryDate}, 'active')
  </insert>

  <!-- 제휴매장 업데이트 (동적) -->
  <update id="updatePartnerShop">
    UPDATE partner_shop
    <set>
      <if test="partnerDate != null and partnerDate != ''">
        partner_date = #{partnerDate},
      </if>
      <if test="expiryDate != null and expiryDate != ''">
        expiry_date = #{expiryDate},
      </if>
      <if test="status != null and status != ''">
        status = #{status},
      </if>
    </set>
    WHERE shop_id = #{shopId}
  </update>

  <!-- 제휴매장 삭제 -->
  <delete id="deleteByShopId">
    DELETE FROM partner_shop WHERE shop_id = #{shopId}
  </delete>

</mapper>


