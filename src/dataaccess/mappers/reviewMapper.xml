<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ReviewMapper">
  <!-- 리뷰 조회 -->
  <select id="getReviewById">
    SELECT 
      r.*,
      u.name as user_name,
      u.profile_img as user_profile_image
    FROM shop_review r
    LEFT JOIN users u ON r.user_id = u.id
    WHERE r.id = #{reviewId}
  </select>

  <!-- 리뷰 목록 조회 - 상점 ID 기준 -->
  <select id="getReviewsByShopId">
    SELECT 
      r.*,
      u.name as user_name,
      u.profile_img as user_profile_image
    FROM shop_review r
    LEFT JOIN users u ON r.user_id = u.id
    WHERE r.shop_id = #{shopId}
    ORDER BY r.reg_date DESC
    LIMIT #{offset}, #{limit}
  </select>

  <!-- 리뷰 이미지 업데이트 - 인덱스 1 -->
  <update id="updateImage1">
    UPDATE shop_review
    SET 
      img_1 = #{imageUrl},
      mod_date = NOW()
    WHERE id = #{reviewId} AND user_id = #{userId}
  </update>

  <!-- 리뷰 이미지 업데이트 - 인덱스 2 -->
  <update id="updateImage2">
    UPDATE shop_review
    SET 
      img_2 = #{imageUrl},
      mod_date = NOW()
    WHERE id = #{reviewId} AND user_id = #{userId}
  </update>

  <!-- 리뷰 이미지 업데이트 - 인덱스 3 -->
  <update id="updateImage3">
    UPDATE shop_review
    SET 
      img_3 = #{imageUrl},
      mod_date = NOW()
    WHERE id = #{reviewId} AND user_id = #{userId}
  </update>

  <!-- 리뷰 이미지 업데이트 - 인덱스 4 -->
  <update id="updateImage4">
    UPDATE shop_review
    SET 
      img_4 = #{imageUrl},
      mod_date = NOW()
    WHERE id = #{reviewId} AND user_id = #{userId}
  </update>

  <!-- 리뷰 이미지 업데이트 - 인덱스 5 -->
  <update id="updateImage5">
    UPDATE shop_review
    SET 
      img_5 = #{imageUrl},
      mod_date = NOW()
    WHERE id = #{reviewId} AND user_id = #{userId}
  </update>

  <!-- 리뷰 이미지 삭제 - 인덱스 1 -->
  <update id="deleteImage1">
    UPDATE shop_review
    SET 
      img_1 = NULL,
      mod_date = NOW()
    WHERE id = #{reviewId} AND user_id = #{userId}
  </update>

  <!-- 리뷰 이미지 삭제 - 인덱스 2 -->
  <update id="deleteImage2">
    UPDATE shop_review
    SET 
      img_2 = NULL,
      mod_date = NOW()
    WHERE id = #{reviewId} AND user_id = #{userId}
  </update>

  <!-- 리뷰 이미지 삭제 - 인덱스 3 -->
  <update id="deleteImage3">
    UPDATE shop_review
    SET 
      img_3 = NULL,
      mod_date = NOW()
    WHERE id = #{reviewId} AND user_id = #{userId}
  </update>

  <!-- 리뷰 이미지 삭제 - 인덱스 4 -->
  <update id="deleteImage4">
    UPDATE shop_review
    SET 
      img_4 = NULL,
      mod_date = NOW()
    WHERE id = #{reviewId} AND user_id = #{userId}
  </update>

  <!-- 리뷰 이미지 삭제 - 인덱스 5 -->
  <update id="deleteImage5">
    UPDATE shop_review
    SET 
      img_5 = NULL,
      mod_date = NOW()
    WHERE id = #{reviewId} AND user_id = #{userId}
  </update>

  <!-- 리뷰 소유권 확인 -->
  <select id="checkReviewOwnership">
    SELECT COUNT(1) as count
    FROM shop_review
    WHERE id = #{reviewId} AND user_id = #{userId}
  </select>
</mapper> 